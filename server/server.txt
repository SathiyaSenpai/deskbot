/**
 * AI DESKBOT SERVER - ES MODULE FIX
 */

import express from 'express';
import { WebSocketServer } from 'ws';
import http from 'http';
import path from 'path';
import os from 'os'; // <--- FIXED: Import 'os' at the top level
import { fileURLToPath } from 'url';
import { textToSpeech, chat } from './ai-services.js'; 

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = 3000; 

// ENABLE CORS
app.use((req, res, next) => {
    res.header("Access-Control-Allow-Origin", "*");
    next();
});

const server = http.createServer(app);
const wss = new WebSocketServer({ server }); 

// Helper to find local IP
function getServerIP() {
    const interfaces = os.networkInterfaces(); // Uses the imported 'os' module
    for (const name of Object.keys(interfaces)) {
        for (const iface of interfaces[name]) {
            if (iface.family === 'IPv4' && !iface.internal) {
                return iface.address;
            }
        }
    }
    return 'localhost';
}

const SERVER_IP = getServerIP();
console.log(`ðŸ“¡ Server IP: ${SERVER_IP}:${PORT}`);

app.use(express.static(path.join(__dirname, 'public')));
app.use(express.json());

let robotWs = null;
let controllers = new Set(); 

console.log(`\nðŸ¤– SERVER READY: Connect PC to Hotspot`);
console.log(`ðŸ“¡ IP MUST BE IN CONFIG.H: Check 'ipconfig' or use: ${SERVER_IP}\n`);

wss.on('connection', (ws, req) => {
    const url = new URL(req.url, `http://${req.headers.host}`);
    const type = url.searchParams.get('type'); 

    // 1. REGISTER ROBOT
    if (type === 'robot') {
        robotWs = ws;
        console.log(`âœ… ROBOT CONNECTED!`);
        broadcast({ type: 'robot_status', state: 'ONLINE' });
    } 
    // 2. REGISTER WEB APP
    else {
        controllers.add(ws);
        console.log(`ðŸ’» WEB APP CONNECTED`);
        ws.send(JSON.stringify({ 
            type: 'robot_status', 
            state: robotWs ? 'ONLINE' : 'OFFLINE' 
        }));
    }

    ws.on('message', async (message) => {
        try {
            const msg = JSON.parse(message);

            // A. FROM ROBOT -> WEB (Sync & Sensors)
            if (ws === robotWs) {
                broadcast(msg); // Forward to Web App

                // AI Logic
                if (msg.event === 'proximity') {
                    console.log(`ðŸ‘€ Proximity! Generating Speech...`);
                    const text = await chat("Greeting: My owner is here.");
                    const audio = await textToSpeech(text);
                    if (audio.audioFile) {
                        // Use dynamic IP
                        robotWs.send(JSON.stringify({ 
                             type: 'play_audio', 
                             url: `http://${SERVER_IP}:${PORT}${audio.audioFile}`
                        }));
                    }
                }
            } 
            
            // B. FROM WEB -> ROBOT (Control)
            else {
                console.log(`ðŸ“± Web Command: ${msg.type}`);
                
                // Handle Chat
                if (msg.type === 'chat_message') {
                    console.log(`ðŸ’¬ User: ${msg.text}`);
                    const reply = await chat(msg.text);
                    const audio = await textToSpeech(reply);
                    
                    // Reply to Web
                    ws.send(JSON.stringify({ type: 'chat_response', text: reply }));
                    
                    // Command Robot
                    if (audio.audioFile) {
                        if (robotWs && robotWs.readyState === 1) {
                            robotWs.send(JSON.stringify({ 
                                type: 'play_audio', 
                                url: `http://${SERVER_IP}:${PORT}${audio.audioFile}`
                            }));
                        }
                    }
                } 
                // Forward Buttons (set_behavior, etc.)
                else if (robotWs && robotWs.readyState === 1) {
                    robotWs.send(JSON.stringify(msg));
                }
            }

        } catch (e) { console.error(e); }
    });

    ws.on('close', () => {
        if (ws === robotWs) {
            console.log(`âŒ ROBOT DISCONNECTED`);
            robotWs = null;
            broadcast({ type: 'robot_status', state: 'OFFLINE' });
        } else {
            controllers.delete(ws);
        }
    });
});

function broadcast(data) {
    const msg = JSON.stringify(data);
    for (let client of controllers) {
        if (client.readyState === 1) client.send(msg);
    }
}

server.listen(PORT, '0.0.0.0', () => console.log(`ðŸš€ Listening on Port ${PORT}`));